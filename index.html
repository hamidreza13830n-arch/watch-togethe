<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Watch Together</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body{
  margin:0;
  background:#0f0f0f;
  font-family:Arial;
  color:white;
}

header{
  background:#111;
  padding:15px;
  font-size:20px;
  display:flex;
  justify-content:space-between;
}

.container{
  max-width:900px;
  margin:auto;
  padding:20px;
}

video{
  width:100%;
  border-radius:12px;
}

.chat-box{
  margin-top:20px;
  height:350px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.message{
  max-width:70%;
  padding:10px 14px;
  border-radius:15px;
  font-size:14px;
  position:relative;
}

.my-message{
  align-self:flex-end;
  background:#0088cc;
  border-bottom-right-radius:4px;
}

.other-message{
  align-self:flex-start;
  background:#262626;
  border-bottom-left-radius:4px;
}

.time{
  font-size:11px;
  opacity:0.7;
  margin-top:4px;
  text-align:right;
}

.seen{
  font-size:11px;
  opacity:0.7;
  text-align:right;
}

.reactions{
  margin-top:5px;
  font-size:16px;
  cursor:pointer;
}

.reaction-buttons span{
  cursor:pointer;
  margin-right:5px;
}

.chat-input{
  margin-top:15px;
  display:flex;
  gap:10px;
}

input{
  padding:10px;
  border-radius:20px;
  border:none;
  outline:none;
}

button{
  padding:10px 18px;
  border:none;
  border-radius:20px;
  background:#e50914;
  color:white;
  cursor:pointer;
}
</style>
</head>
<body>

<header>
<span>ğŸ¬ Watch Together</span>
<span id="onlineCount">Online: 1</span>
</header>

<div class="container">

<input id="movieLink" placeholder="Paste mp4 link">
<button onclick="loadVideo()">Load</button>
<br><br>
<video id="video" controls></video>

<div class="chat-box" id="chat"></div>

<div class="chat-input">
<input id="username" placeholder="Your name">
<input id="message" placeholder="Type message..." style="flex:1">
<button onclick="sendMessage()">Send</button>
</div>

</div>

<script>
var firebaseConfig = {
  apiKey: "AIzaSyCDHmmKIYPHDyvx4BXTb-7VP6lmVb8BCYw",
  authDomain: "film-online-922c1.firebaseapp.com",
  databaseURL: "https://film-online-922c1-default-rtdb.firebaseio.com/",
  projectId: "film-online-922c1",
  storageBucket: "film-online-922c1.firebasestorage.app",
  messagingSenderId: "519581538305",
  appId: "1:519581538305:web:544ac4a73ee1100b6d8800"
};

firebase.initializeApp(firebaseConfig);
var db = firebase.database();
var video = document.getElementById("video");

// Ø­Ø¶ÙˆØ± Ø¢Ù†Ù„Ø§ÛŒÙ†
var userId = Math.random().toString(36).substr(2,9);
var userRef = db.ref("onlineUsers/" + userId);
userRef.set(true);
userRef.onDisconnect().remove();

db.ref("onlineUsers").on("value", snap=>{
  document.getElementById("onlineCount").innerText =
    "Online: " + snap.numChildren();
});

// Ø°Ø®ÛŒØ±Ù‡ Ø§Ø³Ù…
if(localStorage.getItem("username")){
  document.getElementById("username").value =
    localStorage.getItem("username");
}
document.getElementById("username").addEventListener("input",function(){
  localStorage.setItem("username",this.value);
});

// ÙˆÛŒØ¯ÛŒÙˆ Ø³ÛŒÙ†Ú©
function loadVideo(){
  db.ref("video/link").set(
    document.getElementById("movieLink").value
  );
}

db.ref("video/link").on("value",snap=>{
  if(snap.val()) video.src = snap.val();
});

video.onplay=()=>{
  db.ref("video/state").set({
    playing:true,
    time:video.currentTime
  });
};

video.onpause=()=>{
  db.ref("video/state").set({
    playing:false,
    time:video.currentTime
  });
};

db.ref("video/state").on("value",snap=>{
  if(!snap.val()) return;
  video.currentTime = snap.val().time;
  snap.val().playing ? video.play() : video.pause();
});

// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
function sendMessage(){
  var msg=document.getElementById("message").value;
  var name=document.getElementById("username").value||"Guest";

  var now=new Date();
  var time=now.getHours().toString().padStart(2,'0')+
           ":"+
           now.getMinutes().toString().padStart(2,'0');

  db.ref("chat").push({
    user:name,
    text:msg,
    time:time,
    seen:false,
    reactions:{}
  });

  document.getElementById("message").value="";
}

// Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
db.ref("chat").on("child_added",snap=>{
  var data=snap.val();
  var key=snap.key;
  var currentUser=document.getElementById("username").value;

  if(data.user!==currentUser){
    db.ref("chat/"+key+"/seen").set(true);
  }

  var div=document.createElement("div");
  div.className="message "+
    (data.user===currentUser?"my-message":"other-message");

  div.innerHTML=`
    <div>${data.text}</div>
    <div class="time">${data.time}</div>
    <div class="seen">
      ${data.user===currentUser?
        (data.seen?"âœ”âœ” Seen":"âœ” Sent"):""}
    </div>
    <div class="reactions" id="react-${key}"></div>
    <div class="reaction-buttons">
      <span onclick="react('${key}','ğŸ˜')">ğŸ˜</span>
      <span onclick="react('${key}','ğŸ˜')">ğŸ˜</span>
      <span onclick="react('${key}','ğŸ¤£')">ğŸ¤£</span>
      <span onclick="react('${key}','â¤ï¸')">â¤ï¸</span>
      <span onclick="react('${key}','ğŸ‘Œ')">ğŸ‘Œ</span>
    </div>
  `;

  document.getElementById("chat").appendChild(div);
  document.getElementById("chat").scrollTop=
    document.getElementById("chat").scrollHeight;

  db.ref("chat/"+key+"/reactions").on("value",r=>{
    var container=document.getElementById("react-"+key);
    container.innerHTML="";
    if(r.val()){
      Object.values(r.val()).forEach(e=>{
        container.innerHTML+=e+" ";
      });
    }
  });
});

// Ø±ÛŒâ€ŒØ§Ú©Ø´Ù†
function react(key,emoji){
  var id=Math.random().toString(36).substr(2,9);
  db.ref("chat/"+key+"/reactions/"+id).set(emoji);
}
</script>

</body>
</html>
