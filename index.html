<!DOCTYPE html>  
<html>  
<head>  
<meta charset="UTF-8">  
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">  
<title>Watch Together</title>  
  
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>  
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>  
  
<style>  
*{box-sizing:border-box;margin:0;padding:0}  
html,body{height:100%}  
  
body{  
font-family:Arial;  
color:white;  
display:flex;  
flex-direction:column;  
min-height:100dvh;  
overflow:hidden;  
background:linear-gradient(-45deg,#1f1c2c,#928dab,#0f2027,#2c5364);  
background-size:400% 400%;  
animation:bg 12s ease infinite;  
}  
@keyframes bg{  
0%{background-position:0% 50%}  
50%{background-position:100% 50%}  
100%{background-position:0% 50%}  
}  
  
body.dark{background:#0b0b12}  
  
/* üéÑ SMALL CHRISTMAS LIGHTS */  
.light-wrapper{  
position:relative;  
width:100%;  
height:36px;  
flex-shrink:0;  
overflow:hidden;  
}  
  
.light-wire{  
position:absolute;  
top:8px;  
left:0;  
width:100%;  
height:28px;  
}  
  
.light-wire svg{  
width:100%;  
height:100%;  
}  
  
.bulb{  
position:absolute;  
width:9px;  
height:13px;  
border-radius:50% 50% 45% 45%;  
animation:blink 1.4s infinite alternate ease-in-out;  
box-shadow:0 0 6px currentColor,0 0 12px currentColor;  
}  
  
.bulb::before{  
content:"";  
position:absolute;  
top:-3px;  
left:50%;  
transform:translateX(-50%);  
width:5px;  
height:4px;  
background:#222;  
border-radius:2px;  
}  
  
@keyframes blink{  
0%{opacity:1;transform:scale(1)}  
100%{opacity:.5;transform:scale(.85)}  
}  
  
body.dark .light-wrapper{  
opacity:0;  
pointer-events:none;  
}  
/* END LIGHTS */  
  
.glass{  
background:rgba(255,255,255,.08);  
backdrop-filter:blur(12px);  
border:1px solid rgba(255,255,255,.1);  
border-radius:18px;  
}  
  
header{  
height:42px;  
flex-shrink:0;  
display:flex;  
justify-content:space-between;  
align-items:center;  
padding:0 12px;  
}  
  
.main{  
flex:1;  
display:flex;  
flex-direction:column;  
padding:8px;  
gap:8px;  
overflow:hidden;  
}  
  
.video-container{  
flex:0 0 40%;  
padding:10px;  
display:flex;  
flex-direction:column;  
}  
video{  
width:100%;  
flex:1;  
border-radius:12px;  
}  
  
.chat-container{  
flex:1;  
padding:10px;  
display:flex;  
flex-direction:column;  
min-height:0;  
}  
  
.chat-box{  
flex:1;  
overflow-y:auto;  
display:flex;  
flex-direction:column;  
gap:6px;  
}  
  
.message{  
padding:8px 10px;  
border-radius:14px;  
max-width:75%;  
font-size:14px;  
display:flex;  
flex-direction:column;  
gap:4px;  
position:relative;  
}  
  
.me{align-self:flex-end;background:#0088ff;border-bottom-right-radius:4px}  
.other{align-self:flex-start;background:#2a2a32;border-bottom-left-radius:4px}  
  
.meta{  
font-size:10px;  
opacity:.7;  
display:flex;  
justify-content:flex-end;  
gap:4px;  
align-items:center;  
flex-wrap:wrap;  
}  
  
.reply-box{  
font-size:11px;  
opacity:.8;  
border-left:3px solid #fff;  
padding-left:6px;  
margin-bottom:4px;  
}  
  
.reactions{  
display:flex;  
gap:4px;  
font-size:14px;  
margin-top:4px;  
}  
  
.reaction-picker{  
position:absolute;  
bottom:100%;  
background:#1c1c22;  
padding:6px;  
border-radius:10px;  
display:flex;  
gap:6px;  
font-size:18px;  
align-items:center;  
}  

/* ‚úÖ tiny reaction button on each message */
.react-btn{  
font-size:11px;  
opacity:.9;  
padding:2px 5px;  
border-radius:8px;  
border:1px solid rgba(255,255,255,.25);  
background:rgba(0,0,0,.15);  
cursor:pointer;  
user-select:none;  
}  
.react-btn:active{transform:scale(.96)}  

/* ‚úÖ tiny edit button on my messages */
.edit-btn{  
font-size:11px;  
opacity:.9;  
padding:2px 5px;  
border-radius:8px;  
border:1px solid rgba(255,255,255,.25);  
background:rgba(0,0,0,.15);  
cursor:pointer;  
user-select:none;  
}  
.edit-btn:active{transform:scale(.96)}  

/* ‚úÖ close button inside picker */
.picker-close{  
font-size:12px;  
padding:2px 6px;  
border-radius:8px;  
border:1px solid rgba(255,255,255,.25);  
background:rgba(255,255,255,.08);  
cursor:pointer;  
user-select:none;  
}  

/* ‚úÖ typing indicator */
#typingIndicator{  
display:none;  
flex-shrink:0;  
margin-top:6px;  
margin-bottom:4px;  
padding:6px 10px;  
border-radius:14px;  
background:rgba(0,0,0,.16);  
backdrop-filter:blur(10px);  
font-size:12px;  
opacity:.9;  
}  

/* ‚úÖ Telegram-like reply preview above input */
#replyPreview{  
display:none;  
flex-shrink:0;  
margin-top:6px;  
margin-bottom:4px;  
padding:8px 10px;  
border-radius:14px;  
border-left:4px solid #fff;  
background:rgba(0,0,0,.18);  
backdrop-filter:blur(10px);  
}  
#replyPreview .rp-top{  
display:flex;  
justify-content:space-between;  
align-items:center;  
gap:10px;  
margin-bottom:4px;  
font-size:11px;  
opacity:.85;  
}  
#replyPreview .rp-text{  
font-size:12px;  
opacity:.9;  
white-space:nowrap;  
overflow:hidden;  
text-overflow:ellipsis;  
}  
#cancelReply{  
font-size:12px;  
padding:2px 8px;  
border-radius:10px;  
border:1px solid rgba(255,255,255,.25);  
background:rgba(255,255,255,.08);  
color:white;  
cursor:pointer;  
}  
#cancelReply:active{transform:scale(.97)}  

/* ‚úÖ edit preview above input */
#editPreview{  
display:none;  
flex-shrink:0;  
margin-top:6px;  
margin-bottom:4px;  
padding:8px 10px;  
border-radius:14px;  
border-left:4px solid #ffd400;  
background:rgba(0,0,0,.18);  
backdrop-filter:blur(10px);  
}  
#editPreview .ep-top{  
display:flex;  
justify-content:space-between;  
align-items:center;  
gap:10px;  
margin-bottom:4px;  
font-size:11px;  
opacity:.9;  
}  
#editPreview .ep-text{  
font-size:12px;  
opacity:.9;  
white-space:nowrap;  
overflow:hidden;  
text-overflow:ellipsis;  
}  
#cancelEdit{  
font-size:12px;  
padding:2px 8px;  
border-radius:10px;  
border:1px solid rgba(255,255,255,.25);  
background:rgba(255,255,255,.08);  
color:white;  
cursor:pointer;  
}  
#cancelEdit:active{transform:scale(.97)}  
  
.input-area{  
display:flex;  
gap:6px;  
margin-top:6px;  
flex-shrink:0;  
}  
.input-area input{  
flex:1;  
padding:10px;  
border-radius:12px;  
border:none;  
font-size:16px;  
}  
.input-area button{  
padding:10px 12px;  
border:none;  
border-radius:12px;  
background:#e50914;  
color:white;  
}  
  
#settings{  
position:fixed;  
right:-260px;  
top:0;  
width:240px;  
height:100%;  
padding:20px;  
transition:.3s;  
z-index:100;  
}  
#settings.open{right:0}  
#settings button{  
width:100%;  
margin-bottom:10px;  
padding:8px;  
border:none;  
border-radius:10px;  
background:#e50914;  
color:white;  
}  
  
#login{  
position:fixed;  
inset:0;  
background:#000000dd;  
display:flex;  
justify-content:center;  
align-items:center;  
flex-direction:column;  
z-index:999;  
}  
.login-box{  
padding:30px;  
text-align:center;  
}  
.login-box input{  
padding:10px;  
border-radius:12px;  
border:none;  
margin-bottom:10px;  
}  
  
#welcomeOverlay{  
position:fixed;  
inset:0;  
background:rgba(0,0,0,.6);  
display:none;  
justify-content:center;  
align-items:center;  
z-index:998;  
}  
.welcome-box{  
padding:30px;  
text-align:center;  
width:280px;  
}  
.welcome-box button{  
padding:10px 20px;  
border:none;  
border-radius:12px;  
background:#e50914;  
color:white;  
}  
  
@media (orientation:landscape){  
.main{flex-direction:row}  
.video-container{flex:0 0 60%}  
}  
  /* üü¢ ONLINE STATUS DOT */
#onlineDot{
  width:8px;
  height:8px;
  border-radius:50%;
  background:#00ff66;
  box-shadow:0 0 6px #00ff66;
  animation:blinkOnline 1s infinite;
}

@keyframes blinkOnline{
  0%{opacity:1}
  50%{opacity:.3}
  100%{opacity:1}
}
</style>  
</head>  
  
<body>  
  
<div id="login">  
<div class="login-box glass">  
<h3>ÿ±ŸÖÿ≤ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ</h3>  
<input id="pass">  
<button onclick="checkPass()">ÿ™ÿß€å€åÿØ</button>  
</div>  
</div>  
  
<div id="welcomeOverlay">  
<div class="welcome-box glass">  
<h3>ÿ≥ŸÑÿßŸÖ ÿπÿ≤€åÿ≤ŸÖ ‚ù§Ô∏è ÿÆŸàÿ¥ ÿ¢ŸÖÿØ€å</h3>  
<button onclick="closeWelcome()">Ÿàÿ±ŸàÿØ</button>  
</div>  
</div>  
  
<header>  
<span>üé¨ Watch Together</span>  
<div>  
<div style="display:flex;align-items:center;gap:8px;white-space:nowrap;">
  <span id="onlineWrapper" style="display:flex;align-items:center;gap:6px;">
  <span id="onlineDot"></span>
  <span id="online">Online: 1</span>
  </span>
<button onclick="toggleSettings()">‚öôÔ∏è</button>  
</div>  
</header>  
  
<!-- üéÑ LIGHT STRING -->  
<div class="light-wrapper">  
<div class="light-wire">  
<svg viewBox="0 0 1000 100" preserveAspectRatio="none">  
<path d="M0,25 Q100,55 200,25 T400,25 T600,25 T800,25 T1000,25"  
stroke="#111" stroke-width="3" fill="transparent"/>  
</svg>  
</div>  
</div>  
  
<div id="settings" class="glass">  
<h3 style="margin-bottom:10px">ŸæÿÆÿ¥ ŸÅ€åŸÑŸÖ</h3>  
<input id="videoLinkInput" placeholder="ŸÑ€åŸÜ⁄© ŸÅ€åŸÑŸÖ..."  
style="width:100%;padding:8px;border-radius:10px;border:none;margin-bottom:8px">  
<button onclick="setVideoLink()">ŸæÿÆÿ¥ ŸÅ€åŸÑŸÖ</button>  
<hr style="margin:15px 0;opacity:.3">  
<button onclick="toggleDark()">ÿØÿßÿ±⁄© ŸÖŸàÿØ</button>  
<button onclick="clearChat()">ÿ≠ÿ∞ŸÅ ÿ™ÿßÿ±€åÿÆ⁄ÜŸá</button>  
<button onclick="toggleSettings()">ÿ®ÿ≥ÿ™ŸÜ</button>  
</div>  
  
<div class="main">  
<div class="video-container glass">  
<video id="video" controls></video>  
</div>  
  
<div class="chat-container glass">  
<div class="chat-box" id="chat"></div>  

<!-- ‚úÖ Typing indicator -->
<div id="typingIndicator"></div>

<!-- ‚úÖ Edit preview -->
<div id="editPreview">  
  <div class="ep-top">  
    <span>Ÿà€åÿ±ÿß€åÿ¥ Ÿæ€åÿßŸÖ</span>  
    <button id="cancelEdit" onclick="cancelEdit()">ŸÑÿ∫Ÿà</button>  
  </div>  
  <div class="ep-text" id="editPreviewText"></div>  
</div>  

<!-- ‚úÖ Reply preview (Telegram-like) -->
<div id="replyPreview">  
  <div class="rp-top">  
    <span>Reply</span>  
    <button id="cancelReply" onclick="cancelReply()">ŸÑÿ∫Ÿà</button>  
  </div>  
  <div class="rp-text" id="replyPreviewText"></div>  
</div>  

<div class="input-area">  
<input id="msg" placeholder="Ÿæ€åÿßŸÖ...">  
<button onclick="send()">Send</button>  
</div>  
</div>  
</div>  
  
<script>  
/* üéÑ CREATE SMALL BULBS */  
const colors=["#ff2d2d","#ffd400","#00ff88","#00aaff","#ff66ff"];  
const wrapper=document.querySelector(".light-wrapper");  
  
for(let i=0;i<30;i++){  
let bulb=document.createElement("div");  
bulb.className="bulb";  
bulb.style.left=(i*3.4)+"%";  
bulb.style.top=(14+Math.sin(i)*4)+"px";  
bulb.style.color=colors[Math.floor(Math.random()*colors.length)];  
bulb.style.animationDelay=(Math.random()*2)+"s";  
wrapper.appendChild(bulb);  
}  
  
setInterval(()=>{  
document.querySelectorAll(".bulb").forEach(b=>{  
b.style.color=colors[Math.floor(Math.random()*colors.length)];  
});  
},2000);  
</script>  
  
<script>  
var firebaseConfig={  
apiKey:"AIzaSyCDHmmKIYPHDyvx4BXTb-7VP6lmVb8BCYw",  
authDomain:"film-online-922c1.firebaseapp.com",  
databaseURL:"https://film-online-922c1-default-rtdb.firebaseio.com/",  
projectId:"film-online-922c1"  
};  
firebase.initializeApp(firebaseConfig);  
var db=firebase.database();  
  
var username="user"+Math.floor(Math.random()*1000);  
var myId=Math.random().toString(36).substr(2,9);  
var replyTo=null;  
var editKey=null;  
  
function checkPass(){  
if(pass.value==="bazsho20"){  
login.style.display="none";  
welcomeOverlay.style.display="flex";  
}  
}  
function closeWelcome(){welcomeOverlay.style.display="none"}  
function toggleSettings(){settings.classList.toggle("open")}  
function toggleDark(){document.body.classList.toggle("dark")}  
  
function setVideoLink(){  
var link=document.getElementById("videoLinkInput").value;  
if(!link)return;  
db.ref("video/url").set(link);  
videoLinkInput.value="";  
toggleSettings();  
}  
db.ref("video/url").on("value",snap=>{  
if(snap.val())video.src=snap.val();  
});  

/* ===================== */
/* ‚úÖ VIDEO SYNC ADDED ‚úÖ */
/* ===================== */
var vid=document.getElementById("video");  
var isSyncing=false;  
var lastSeekSend=0;  

function pushState(state){  
db.ref("video/state").set(state);  
}  

vid.addEventListener("play",()=>{  
if(isSyncing)return;  
pushState({  
action:"play",  
time:vid.currentTime,  
rate:vid.playbackRate,  
ts:Date.now()  
});  
});  

vid.addEventListener("pause",()=>{  
if(isSyncing)return;  
pushState({  
action:"pause",  
time:vid.currentTime,  
rate:vid.playbackRate,  
ts:Date.now()  
});  
});  

vid.addEventListener("seeked",()=>{  
if(isSyncing)return;  
var now=Date.now();  
if(now-lastSeekSend<250)return;  
lastSeekSend=now;  
pushState({  
action:"seek",  
time:vid.currentTime,  
rate:vid.playbackRate,  
ts:now  
});  
});  

vid.addEventListener("ratechange",()=>{  
if(isSyncing)return;  
pushState({  
action:"rate",  
time:vid.currentTime,  
rate:vid.playbackRate,  
ts:Date.now()  
});  
});  

db.ref("video/state").on("value",snap=>{  
var s=snap.val();  
if(!s)return;  
isSyncing=true;  

if(typeof s.rate==="number" && vid.playbackRate!==s.rate){  
vid.playbackRate=s.rate;  
}  

if(typeof s.time==="number" && Math.abs(vid.currentTime-s.time)>0.6){  
try{vid.currentTime=s.time;}catch(e){}  
}  

if(s.action==="play"){  
var p=vid.play();  
if(p && p.catch)p.catch(()=>{});  
}  
if(s.action==="pause"){  
vid.pause();  
}  

setTimeout(()=>{isSyncing=false;},300);  
});  
/* ===== END SYNC ===== */  
  
/* üü¢ PROFESSIONAL ONLINE SYSTEM */
var connectedRef = db.ref(".info/connected");

connectedRef.on("value", function(snap) {
  if (snap.val() === true) {
    var con = db.ref("online/" + myId);
    con.set({
      user: username,
      ts: Date.now()
    });
    con.onDisconnect().remove();
  }
});

db.ref("online").on("value", snap => {
  var count = 0;
  snap.forEach(child => {
    if(child.val()) count++;
  });
  document.getElementById("online").innerText = "Online: " + count;
});

/*****************************/
/* ‚úÖ REPLY PREVIEW SYSTEM ‚úÖ */
/*****************************/
function setReply(text){  
replyTo=text;  
var box=document.getElementById("replyPreview");  
var t=document.getElementById("replyPreviewText");  
t.innerText=text;  
box.style.display="block";  
try{msg.focus();}catch(e){}  
}  

function cancelReply(){  
replyTo=null;  
var box=document.getElementById("replyPreview");  
box.style.display="none";  
document.getElementById("replyPreviewText").innerText="";  
}  

/****************************/
/* ‚úÖ EDIT MESSAGE SYSTEM ‚úÖ */
/****************************/
function setEdit(key,oldText){  
editKey=key;  
document.getElementById("editPreviewText").innerText=oldText;  
document.getElementById("editPreview").style.display="block";  
msg.value=oldText;  
try{msg.focus();}catch(e){}  
cancelReply();  
}  

function cancelEdit(){  
editKey=null;  
document.getElementById("editPreview").style.display="none";  
document.getElementById("editPreviewText").innerText="";  
msg.value="";  
}  

/*****************************/
/* ‚úÖ TYPING INDICATOR ‚úÖ     */
/*****************************/
function setTyping(isTyping){  
db.ref("typing/"+myId).set(isTyping?{user:username,typing:true,ts:Date.now()}:null);  
}  
db.ref("typing/"+myId).onDisconnect().remove();  

var typingTimer=null;  
msg.addEventListener("input",()=>{  
setTyping(true);  
if(typingTimer)clearTimeout(typingTimer);  
typingTimer=setTimeout(()=>{  
setTyping(false);  
},900);  
});  
msg.addEventListener("blur",()=>{  
setTyping(false);  
});  

db.ref("typing").on("value",snap=>{  
var names=[];  
snap.forEach(c=>{  
if(c.key!==myId && c.val() && c.val().typing){  
names.push(c.val().user||"someone");  
}  
});  
var box=document.getElementById("typingIndicator");  
if(names.length){  
box.style.display="block";  
box.innerText=(names.length===1?names[0]:"⁄ÜŸÜÿØ ŸÜŸÅÿ±")+" ÿØÿ± ÿ≠ÿßŸÑ ÿ™ÿß€åŸæ...";  
}else{  
box.style.display="none";  
box.innerText="";  
}  
});  

/*****************************/
/* ‚úÖ CLOSE ANY OPEN PICKER ‚úÖ */
/*****************************/
function closeAllPickers(){  
document.querySelectorAll(".reaction-picker").forEach(p=>p.remove());  
}  
document.addEventListener("click",()=>{  
closeAllPickers();  
});  

function send(){  
if(!msg.value)return;  

if(editKey){  
db.ref("chat/"+editKey+"/text").set(msg.value);  
db.ref("chat/"+editKey+"/edited").set(true);  
msg.value="";  
cancelEdit();  
setTyping(false);  
return;  
}  

db.ref("chat").push({  
text:msg.value,  
user:username,  
time:Date.now(),  
reply:replyTo,  
seen:false,  
edited:false,  
reactions:{}  
});  
msg.value="";  
cancelReply();  
setTyping(false);  
}  

/********************************************/
/* ‚úÖ DOUBLE TAP / DOUBLE CLICK TO REPLY ‚úÖ */
/********************************************/
var lastTapTimeByKey={};  

function attachReplyHandlers(div,key,text){  
div.addEventListener("dblclick",function(e){  
e.stopPropagation();  
setReply(text);  
});  

div.addEventListener("touchend",function(e){  
var now=Date.now();  
var last=lastTapTimeByKey[key]||0;  
lastTapTimeByKey[key]=now;  
if(now-last<320){  
try{e.preventDefault();}catch(err){}  
setReply(text);  
}  
},{passive:false});  
}  

db.ref("chat").on("child_added",snap=>{  
var d=snap.val();  
var key=snap.key;  
if(d.user!==username){  
db.ref("chat/"+key+"/seen").set(true);  
}  
var div=document.createElement("div");  
div.className="message "+(d.user===username?"me":"other");  
div.id="m_"+key;  
  
if(d.reply){  
var rep=document.createElement("div");  
rep.className="reply-box";  
rep.innerText=d.reply;  
div.appendChild(rep);  
}  
  
var text=document.createElement("div");  
text.innerText=d.text;  
div.appendChild(text);  
  
var meta=document.createElement("div");  
meta.className="meta";  

/*************************************/
/* ‚úÖ SMALL BUTTONS PER MSG ‚úÖ */
/*************************************/
var reactBtn=document.createElement("span");  
reactBtn.className="react-btn";  
reactBtn.innerText="üòä";  
reactBtn.onclick=function(ev){  
ev.stopPropagation();  
closeAllPickers();  
showReactions(key,div);  
};  

if(d.user===username){  
var editBtn=document.createElement("span");  
editBtn.className="edit-btn";  
editBtn.innerText="‚úé";  
editBtn.onclick=function(ev){  
ev.stopPropagation();  
closeAllPickers();  
setEdit(key,d.text);  
};  
}  

meta.innerHTML=new Date(d.time).toLocaleTimeString().slice(0,5)  
+(d.edited?" <span style='opacity:.75'>(edited)</span>":"")  
+(d.user===username?" <span id='s"+key+"'>‚úî</span>":"");  

if(d.user===username){  
meta.appendChild(editBtn);  
}  
meta.appendChild(reactBtn);  
div.appendChild(meta);  
  
var react=document.createElement("div");  
react.className="reactions";  
div.appendChild(react);  

/********************************************/
/* ‚úÖ CHANGE: click no longer sets reply ‚úÖ */
/* (reply only on double tap / dblclick)    */
/********************************************/
div.onclick=function(e){  
e.stopPropagation();  
};  

attachReplyHandlers(div,key,d.text);  
  
chat.appendChild(div);  
chat.scrollTop=chat.scrollHeight;  
  
if(d.user===username){  
db.ref("chat/"+key+"/seen").on("value",s=>{  
document.getElementById("s"+key).innerText=s.val()?"‚úî‚úî":"‚úî";  
});  
}  
});  
  
function showReactions(key,div){  
if(div.querySelector(".reaction-picker"))return;  
var picker=document.createElement("div");  
picker.className="reaction-picker";  

/*************************************/
/* ‚úÖ CANCEL/CLOSE BUTTON IN PANEL ‚úÖ */
/*************************************/
var close=document.createElement("span");  
close.className="picker-close";  
close.innerText="‚úï";  
close.onclick=function(ev){  
ev.stopPropagation();  
picker.remove();  
};  
picker.appendChild(close);  

["üòç","üòé","ü§£","ü©∑","üëå","üò≠","üò°","üî•","üòú"].forEach(e=>{  
var span=document.createElement("span");  
span.innerText=e;  
span.onclick=function(ev){  
ev.stopPropagation();  
db.ref("chat/"+key+"/reactions/"+myId).set(e);  
picker.remove();  
};  
picker.appendChild(span);  
});  
div.appendChild(picker);  
}  
  
db.ref("chat").on("child_changed",snap=>{  
var d=snap.val();  

/********** update message text + edited label **********/
var m=document.getElementById("m_"+snap.key);  
if(m){  
var mainText=m.querySelector("div:nth-child("+(d.reply?2:1)+")");  
if(mainText)mainText.innerText=d.text;  

var meta=m.querySelector(".meta");  
if(meta){  
var timeStr=new Date(d.time).toLocaleTimeString().slice(0,5);  
var editedStr=d.edited?" <span style='opacity:.75'>(edited)</span>":"";  
if(d.user===username){  
meta.innerHTML=timeStr+editedStr+" <span id='s"+snap.key+"'>"+(d.seen?"‚úî‚úî":"‚úî")+"</span>";  
var editBtn=document.createElement("span");  
editBtn.className="edit-btn";  
editBtn.innerText="‚úé";  
editBtn.onclick=function(ev){  
ev.stopPropagation();  
closeAllPickers();  
setEdit(snap.key,d.text);  
};  
meta.appendChild(editBtn);  

var reactBtn=document.createElement("span");  
reactBtn.className="react-btn";  
reactBtn.innerText="üòä";  
reactBtn.onclick=function(ev){  
ev.stopPropagation();  
closeAllPickers();  
showReactions(snap.key,m);  
};  
meta.appendChild(reactBtn);  
}else{  
meta.innerHTML=timeStr+editedStr;  
var reactBtn=document.createElement("span");  
reactBtn.className="react-btn";  
reactBtn.innerText="üòä";  
reactBtn.onclick=function(ev){  
ev.stopPropagation();  
closeAllPickers();  
showReactions(snap.key,m);  
};  
meta.appendChild(reactBtn);  
}  
}  
}  

/********** update reactions **********/
var react=document.querySelector("#m_"+snap.key+" .reactions");  
if(react){  
react.innerHTML="";  
if(d.reactions){  
Object.values(d.reactions).forEach(e=>{  
react.innerHTML+=e+" ";  
});  
}  
}  
});  
  
function clearChat(){  
db.ref("chat").remove();  
chat.innerHTML="";  
cancelReply();  
cancelEdit();  
}  
</script>  
  
</body>  
</html>
