<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watch Together</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
  body{
    margin:0;
    background:#0f0f0f;
    font-family:Arial;
    color:white;
    height:100vh;
    display:flex;
    flex-direction:column;
  }

  header{
    background:#111;
    padding:12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-weight:bold;
  }

  .main{ flex:1; display:flex; flex-direction:column; }

  /* ğŸ¬ ÙÛŒÙ„Ù… Ø¨Ø²Ø±Ú¯â€ŒØªØ± */
  .video-container{
    flex:1.35;
    background:black;
    display:flex;
    flex-direction:column;
    gap:10px;
    padding:10px;
  }

  .link-bar{
    display:flex;
    gap:8px;
  }

  .link-bar input{
    flex:1;
    padding:10px 12px;
    border-radius:18px;
    border:none;
    outline:none;
  }

  .link-bar button{
    padding:10px 14px;
    border:none;
    border-radius:18px;
    background:#e50914;
    color:white;
    cursor:pointer;
    font-weight:bold;
    white-space:nowrap;
  }

  video{
    width:100%;
    height:100%;
    border-radius:12px;
    object-fit:contain;
    background:#000;
  }

  /* ğŸ’¬ Ú†Øª Ú©ÙˆÚ†ÛŒÚ©â€ŒØªØ± */
  .chat-container{
    flex:1;
    display:flex;
    flex-direction:column;
    padding:12px 15px 25px 15px;
  }

  .chat-box{
    flex:1;
    overflow-y:auto;
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .message{
    max-width:78%;
    padding:10px 14px;
    border-radius:15px;
    font-size:14px;
    position:relative;
    cursor:pointer;
    word-break:break-word;
  }

  .my-message{
    align-self:flex-end;
    background:#0088cc;
    border-bottom-right-radius:4px;
  }

  .other-message{
    align-self:flex-start;
    background:#262626;
    border-bottom-left-radius:4px;
  }

  .meta-row{
    display:flex;
    justify-content:flex-end;
    gap:8px;
    margin-top:4px;
    font-size:11px;
    opacity:0.75;
  }

  .reactions{
    margin-top:6px;
    font-size:16px;
    opacity:0.95;
  }

  /* ØªÙ„Ú¯Ø±Ø§Ù…â€ŒØ·ÙˆØ±: Ù¾Ù†Ù„ Ø±ÛŒâ€ŒØ§Ú©Ø´Ù† Ø±ÙˆÛŒ Ù¾ÛŒØ§Ù… */
  .reaction-picker{
    position:absolute;
    bottom:100%;
    right:0;
    background:#1f1f1f;
    padding:6px 10px;
    border-radius:18px;
    display:flex;
    gap:8px;
    box-shadow:0 0 10px rgba(0,0,0,0.55);
    z-index:10;
  }
  .other-message .reaction-picker{ right:auto; left:0; }

  .reaction-picker span{
    cursor:pointer;
    font-size:18px;
    line-height:1;
  }

  /* âœ¨ Ú©Ø§Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ú©Ù…ÛŒ Ø¨Ø§Ù„Ø§ØªØ± */
  .input-area{
    display:flex;
    gap:8px;
    margin-top:10px;
    margin-bottom:10px;
  }

  .input-area input{
    flex:1;
    padding:10px;
    border-radius:20px;
    border:none;
    outline:none;
  }

  .input-area button{
    padding:10px 16px;
    border:none;
    border-radius:20px;
    background:#e50914;
    color:white;
    cursor:pointer;
    font-weight:bold;
  }

  @media (orientation: landscape){
    .main{ flex-direction:row; }
    .video-container{ flex:1.45; }
    .chat-container{ flex:1; }
  }
</style>
</head>

<body>

<header>
  <span>ğŸ¬ Ø¨Ø§ Ù‡Ù… ØªÙ…Ø§Ø´Ø§ Ú©Ù†ÛŒØ¯</span>
  <span id="onlineCount">Online: 1</span>
</header>

<div class="main">

  <div class="video-container">
    <div class="link-bar">
      <input id="movieLink" placeholder="Paste mp4 direct link...">
      <button onclick="loadVideo()">Load</button>
    </div>
    <video id="video" controls></video>
  </div>

  <div class="chat-container">
    <div class="chat-box" id="chat"></div>

    <div class="input-area">
      <input id="username" placeholder="Name">
      <input id="message" placeholder="Message">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

</div>

<script>
  var firebaseConfig={
    apiKey:"AIzaSyCDHmmKIYPHDyvx4BXTb-7VP6lmVb8BCYw",
    authDomain:"film-online-922c1.firebaseapp.com",
    databaseURL:"https://film-online-922c1-default-rtdb.firebaseio.com/",
    projectId:"film-online-922c1"
  };

  firebase.initializeApp(firebaseConfig);
  var db = firebase.database();
  var video = document.getElementById("video");

  // âœ… Ø°Ø®ÛŒØ±Ù‡ Ø§Ø³Ù… (Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø³ÛŒÙ†/Ø±Ø§Ø³Øªâ€ŒÚ†Ù¾ Ø¯Ø±Ø³Øª Ú©Ø§Ø± Ú©Ù†Ù‡)
  if (localStorage.getItem("username")) {
    document.getElementById("username").value = localStorage.getItem("username");
  }
  document.getElementById("username").addEventListener("input", function(){
    localStorage.setItem("username", this.value);
  });

  // âœ… Ø¢Ù†Ù„Ø§ÛŒÙ†â€ŒÙ‡Ø§
  var userId = Math.random().toString(36).substr(2,9);
  var userRef = db.ref("onlineUsers/" + userId);
  userRef.set(true);
  userRef.onDisconnect().remove();

  db.ref("onlineUsers").on("value", snap=>{
    document.getElementById("onlineCount").innerText = "Online: " + snap.numChildren();
  });

  // ğŸ§¹ Ù¾Ø§Ú© Ø´Ø¯Ù† Ú†Øª Ù‡Ù†Ú¯Ø§Ù… ÙˆØ±ÙˆØ¯ (Ø·Ø¨Ù‚ Ø®ÙˆØ§Ø³ØªÙ‡â€ŒØ§Øª)
  // Ù‡Ø´Ø¯Ø§Ø±: Ù‡Ø±Ú©Ø³ÛŒ ÙˆØ§Ø±Ø¯ Ø¨Ø´Ù‡ Ú†Øª Ø±Ùˆ Ù¾Ø§Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù‡.
  db.ref("chat").remove();

  // ğŸ”— Ù„ÛŒÙ†Ú© ÙˆÛŒØ¯ÛŒÙˆ
  function loadVideo(){
    var link = document.getElementById("movieLink").value.trim();
    if(!link) return;
    db.ref("video/link").set(link);
  }

  db.ref("video/link").on("value", snap=>{
    if (snap.val()) video.src = snap.val();
  });

  // âœ… Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… + Ø²Ù…Ø§Ù† + seen + reactions
  function sendMessage(){
    var msg = document.getElementById("message").value.trim();
    if(!msg) return;

    var name = document.getElementById("username").value.trim() || "Guest";

    var now = new Date();
    var time = now.getHours().toString().padStart(2,'0') + ":" +
               now.getMinutes().toString().padStart(2,'0');

    db.ref("chat").push({
      user: name,
      text: msg,
      time: time,
      seen: false,
      reactions: {}
    });

    document.getElementById("message").value = "";
  }

  // âœ… Ø±ÛŒâ€ŒØ§Ú©Ø´Ù† (ÙÙ‚Ø· Ûµ ØªØ§)
  function addReaction(key, emoji){
    // ÛŒÚ© Ø±ÛŒâ€ŒØ§Ú©Ø´Ù† Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù†ÙØ± (Ø¨Ø§ userId) => Ø´Ø¨ÛŒÙ‡â€ŒØªØ± Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
    db.ref("chat/" + key + "/reactions/" + userId).set(emoji);
  }

  // Ù¾Ù†Ù„ Ø±ÛŒâ€ŒØ§Ú©Ø´Ù† Ø±ÙˆÛŒ Ù¾ÛŒØ§Ù…
  function showPicker(messageDiv, key){
    // Ø§Ú¯Ø± Ù¾Ù†Ù„ Ø¨Ø§Ø²Ù‡ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù†Ø³Ø§Ø²
    if(messageDiv.querySelector(".reaction-picker")) return;

    var picker = document.createElement("div");
    picker.className = "reaction-picker";

    ["ğŸ˜","ğŸ˜","ğŸ¤£","â¤ï¸","ğŸ‘Œ"].forEach(emoji=>{
      var s = document.createElement("span");
      s.textContent = emoji;
      s.onclick = (e)=>{
        e.stopPropagation();
        addReaction(key, emoji);
        picker.remove();
      };
      picker.appendChild(s);
    });

    messageDiv.appendChild(picker);

    // Ú©Ù„ÛŒÚ© Ø¨ÛŒØ±ÙˆÙ† => Ø¨Ø³ØªÙ‡ Ø´ÙˆØ¯
    setTimeout(()=>{
      document.addEventListener("click", ()=>{
        if(picker && picker.parentNode) picker.remove();
      }, { once:true });
    }, 0);
  }

  // Ø±Ù†Ø¯Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
  db.ref("chat").on("child_added", snap=>{
    var data = snap.val();
    var key  = snap.key;
    var currentUser = (document.getElementById("username").value || "").trim();

    // âœ… Seen: Ø§Ú¯Ø± Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ù…Ø§Ù„ Ù…Ù† Ù†ÛŒØ³ØªØŒ ÛŒØ¹Ù†ÛŒ Ù…Ù† Ø¯ÛŒØ¯Ù… => seen=true
    if (data.user !== currentUser) {
      db.ref("chat/" + key + "/seen").set(true);
    }

    var div = document.createElement("div");
    var isMine = (data.user === currentUser);

    div.className = "message " + (isMine ? "my-message" : "other-message");
    div.id = "msg-" + key;

    div.innerHTML = `
      <div>${escapeHtml(data.text)}</div>
      <div class="reactions" id="react-${key}"></div>
      <div class="meta-row">
        <span>${escapeHtml(data.time || "")}</span>
        ${isMine ? `<span id="seen-${key}">âœ”</span>` : ``}
      </div>
    `;

    div.onclick = ()=> showPicker(div, key);

    var chat = document.getElementById("chat");
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;

    // âœ… Ø¢Ù¾Ø¯ÛŒØª Ø³ÛŒÙ† (Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¯Ù…)
    if (isMine) {
      db.ref("chat/" + key + "/seen").on("value", s=>{
        var el = document.getElementById("seen-" + key);
        if(!el) return;
        el.textContent = s.val() ? "âœ”âœ”" : "âœ”";
      });
    }

    // âœ… Ù†Ù…Ø§ÛŒØ´ Ø±ÛŒâ€ŒØ§Ú©Ø´Ù†â€ŒÙ‡Ø§
    db.ref("chat/" + key + "/reactions").on("value", r=>{
      var container = document.getElementById("react-" + key);
      if(!container) return;

      container.innerHTML = "";
      var val = r.val();
      if (!val) return;

      // Ø´Ù…Ø§Ø±Ø´ Ø§ÛŒÙ…ÙˆØ¬ÛŒâ€ŒÙ‡Ø§ (Ø§Ú¯Ø± Ú†Ù†Ø¯ Ù†ÙØ± ÛŒÚ©ÛŒ Ø±Ùˆ Ø¨Ø²Ù†Ù†ØŒ Ù…Ø«Ù„ ØªÙ„Ú¯Ø±Ø§Ù… Ú©Ù†Ø§Ø± Ù‡Ù… Ù…ÛŒØ§Ø¯)
      var counts = {};
      Object.values(val).forEach(e=>{
        counts[e] = (counts[e] || 0) + 1;
      });

      // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø«Ø§Ø¨Øª Ø¨Ø±Ø§ÛŒ Ù‚Ø´Ù†Ú¯ÛŒ
      ["ğŸ˜","ğŸ˜","ğŸ¤£","â¤ï¸","ğŸ‘Œ"].forEach(e=>{
        if(counts[e]){
          container.innerHTML += counts[e] > 1 ? `${e} ${counts[e]} ` : `${e} `;
        }
      });
    });
  });

  // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØ²Ø±ÛŒÙ‚ HTML Ø¯Ø§Ø®Ù„ Ù¾ÛŒØ§Ù…
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, function(m){
      return ({
        "&":"&amp;",
        "<":"&lt;",
        ">":"&gt;",
        '"':"&quot;",
        "'":"&#039;"
      })[m];
    });
  }
</script>

</body>
</html>
