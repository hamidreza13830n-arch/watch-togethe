<!DOCTYPE html>  
<html>  
<head>  
<meta charset="UTF-8">  
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">  
<title>Watch Together</title>  
  
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>  
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>  
  
<style>  
*{box-sizing:border-box;margin:0;padding:0}  
html,body{height:100%}  
  
body{  
font-family:Arial;  
color:white;  
display:flex;  
flex-direction:column;  
min-height:100dvh;  
overflow:hidden;  
background:linear-gradient(-45deg,#1f1c2c,#928dab,#0f2027,#2c5364);  
background-size:400% 400%;  
animation:bg 12s ease infinite;  
}  
@keyframes bg{  
0%{background-position:0% 50%}  
50%{background-position:100% 50%}  
100%{background-position:0% 50%}  
}  
  
body.dark{background:#0b0b12}  
  
/* ğŸ„ SMALL CHRISTMAS LIGHTS */  
.light-wrapper{  
position:relative;  
width:100%;  
height:36px;  
flex-shrink:0;  
overflow:hidden;  
}  
  
.light-wire{  
position:absolute;  
top:8px;  
left:0;  
width:100%;  
height:28px;  
}  
  
.light-wire svg{  
width:100%;  
height:100%;  
}  
  
.bulb{  
position:absolute;  
width:9px;  
height:13px;  
border-radius:50% 50% 45% 45%;  
animation:blink 1.4s infinite alternate ease-in-out;  
box-shadow:0 0 6px currentColor,0 0 12px currentColor;  
}  
  
.bulb::before{  
content:"";  
position:absolute;  
top:-3px;  
left:50%;  
transform:translateX(-50%);  
width:5px;  
height:4px;  
background:#222;  
border-radius:2px;  
}  
  
@keyframes blink{  
0%{opacity:1;transform:scale(1)}  
100%{opacity:.5;transform:scale(.85)}  
}  
  
body.dark .light-wrapper{  
opacity:0;  
pointer-events:none;  
}  
/* END LIGHTS */  
  
.glass{  
background:rgba(255,255,255,.08);  
backdrop-filter:blur(12px);  
border:1px solid rgba(255,255,255,.1);  
border-radius:18px;  
}  
  
header{  
height:42px;  
flex-shrink:0;  
display:flex;  
justify-content:space-between;  
align-items:center;  
padding:0 12px;  
}  
  
.main{  
flex:1;  
display:flex;  
flex-direction:column;  
padding:8px;  
gap:8px;  
overflow:hidden;  
}  
  
.video-container{  
flex:0 0 40%;  
padding:10px;  
display:flex;  
flex-direction:column;  
}  
video{  
width:100%;  
flex:1;  
border-radius:12px;  
}  
  
.chat-container{  
flex:1;  
padding:10px;  
display:flex;  
flex-direction:column;  
min-height:0;  
}  
  
.chat-box{  
flex:1;  
overflow-y:auto;  
display:flex;  
flex-direction:column;  
gap:6px;  
}  
  
.message{  
padding:8px 10px;  
border-radius:14px;  
max-width:75%;  
font-size:14px;  
display:flex;  
flex-direction:column;  
gap:4px;  
position:relative;  
}  
  
.me{align-self:flex-end;background:#0088ff;border-bottom-right-radius:4px}  
.other{align-self:flex-start;background:#2a2a32;border-bottom-left-radius:4px}  
  
.meta{  
font-size:10px;  
opacity:.7;  
display:flex;  
justify-content:flex-end;  
gap:4px;  
align-items:center;  
flex-wrap:wrap;  
}  
  
.reply-box{  
font-size:11px;  
opacity:.8;  
border-left:3px solid #fff;  
padding-left:6px;  
margin-bottom:4px;  
}  
  
.reactions{  
display:flex;  
gap:4px;  
font-size:14px;  
margin-top:4px;  
}  
  
.reaction-picker{  
position:absolute;  
bottom:100%;  
background:#1c1c22;  
padding:6px;  
border-radius:10px;  
display:flex;  
gap:6px;  
font-size:18px;  
align-items:center;  
}  

/* âœ… tiny reaction button on each message */
.react-btn{  
font-size:11px;  
opacity:.9;  
padding:2px 5px;  
border-radius:8px;  
border:1px solid rgba(255,255,255,.25);  
background:rgba(0,0,0,.15);  
cursor:pointer;  
user-select:none;  
}  
.react-btn:active{transform:scale(.96)}  

/* âœ… tiny edit button on my messages */
.edit-btn{  
font-size:11px;  
opacity:.9;  
padding:2px 5px;  
border-radius:8px;  
border:1px solid rgba(255,255,255,.25);  
background:rgba(0,0,0,.15);  
cursor:pointer;  
user-select:none;  
}  
.edit-btn:active{transform:scale(.96)}  

/* âœ… close button inside picker */
.picker-close{  
font-size:12px;  
padding:2px 6px;  
border-radius:8px;  
border:1px solid rgba(255,255,255,.25);  
background:rgba(255,255,255,.08);  
cursor:pointer;  
user-select:none;  
}  

/* âœ… typing indicator */
#typingIndicator{  
display:none;  
flex-shrink:0;  
margin-top:6px;  
margin-bottom:4px;  
padding:6px 10px;  
border-radius:14px;  
background:rgba(0,0,0,.16);  
backdrop-filter:blur(10px);  
font-size:12px;  
opacity:.9;  
}  

/* âœ… Telegram-like reply preview above input */
#replyPreview{  
display:none;  
flex-shrink:0;  
margin-top:6px;  
margin-bottom:4px;  
padding:8px 10px;  
border-radius:14px;  
border-left:4px solid #fff;  
background:rgba(0,0,0,.18);  
backdrop-filter:blur(10px);  
}  
#replyPreview .rp-top{  
display:flex;  
justify-content:space-between;  
align-items:center;  
gap:10px;  
margin-bottom:4px;  
font-size:11px;  
opacity:.85;  
}  
#replyPreview .rp-text{  
font-size:12px;  
opacity:.9;  
white-space:nowrap;  
overflow:hidden;  
text-overflow:ellipsis;  
}  
#cancelReply{  
font-size:12px;  
padding:2px 8px;  
border-radius:10px;  
border:1px solid rgba(255,255,255,.25);  
background:rgba(255,255,255,.08);  
color:white;  
cursor:pointer;  
}  
#cancelReply:active{transform:scale(.97)}  

/* âœ… edit preview above input */
#editPreview{  
display:none;  
flex-shrink:0;  
margin-top:6px;  
margin-bottom:4px;  
padding:8px 10px;  
border-radius:14px;  
border-left:4px solid #ffd400;  
background:rgba(0,0,0,.18);  
backdrop-filter:blur(10px);  
}  
#editPreview .ep-top{  
display:flex;  
justify-content:space-between;  
align-items:center;  
gap:10px;  
margin-bottom:4px;  
font-size:11px;  
opacity:.9;  
}  
#editPreview .ep-text{  
font-size:12px;  
opacity:.9;  
white-space:nowrap;  
overflow:hidden;  
text-overflow:ellipsis;  
}  
#cancelEdit{  
font-size:12px;  
padding:2px 8px;  
border-radius:10px;  
border:1px solid rgba(255,255,255,.25);  
background:rgba(255,255,255,.08);  
color:white;  
cursor:pointer;  
}  
#cancelEdit:active{transform:scale(.97)}  
  
.input-area{  
display:flex;  
gap:6px;  
margin-top:6px;  
flex-shrink:0;  
}  
.input-area input{  
flex:1;  
padding:10px;  
border-radius:12px;  
border:none;  
font-size:16px;  
}  
.input-area button{  
padding:10px 12px;  
border:none;  
border-radius:12px;  
background:#e50914;  
color:white;  
}  
  
#settings{  
position:fixed;  
right:-260px;  
top:0;  
width:240px;  
height:100%;  
padding:20px;  
transition:.3s;  
z-index:100;  
}  
#settings.open{right:0}  
#settings button{  
width:100%;  
margin-bottom:10px;  
padding:8px;  
border:none;  
border-radius:10px;  
background:#e50914;  
color:white;  
}  
  
#login{  
position:fixed;  
inset:0;  
background:#000000dd;  
display:flex;  
justify-content:center;  
align-items:center;  
flex-direction:column;  
z-index:999;  
}  
.login-box{  
padding:30px;  
text-align:center;  
}  
.login-box input{  
padding:10px;  
border-radius:12px;  
border:none;  
margin-bottom:10px;  
}  
  
#welcomeOverlay{  
position:fixed;  
inset:0;  
background:rgba(0,0,0,.6);  
display:none;  
justify-content:center;  
align-items:center;  
z-index:998;  
}  
.welcome-box{  
padding:30px;  
text-align:center;  
width:280px;  
}  
.welcome-box button{  
padding:10px 20px;  
border:none;  
border-radius:12px;  
background:#e50914;  
color:white;  
}  
  
@media (orientation:landscape){  
.main{flex-direction:row}  
.video-container{flex:0 0 60%}  
}  
  /* ğŸŸ¢ ONLINE STATUS DOT */
#onlineDot{
  width:8px;
  height:8px;
  border-radius:50%;
  background:#00ff66;
  box-shadow:0 0 6px #00ff66;
  animation:blinkOnline 1s infinite;
}

@keyframes blinkOnline{
  0%{opacity:1}
  50%{opacity:.3}
  100%{opacity:1}
}
  /* ğŸ­ CINEMA CURTAIN */
.video-container{position:relative;} /* Ø§Ø¶Ø§ÙÙ‡: Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ù¾Ø±Ø¯Ù‡ Ø±ÙˆÛŒ ÙˆÛŒØ¯ÛŒÙˆ Ø¯Ø±Ø³Øª Ø¨Ø´ÛŒÙ†Ù‡ */

#curtain{
  position:absolute;
  inset:10px;              /* Ù‡Ù…â€ŒØ±Ø§Ø³ØªØ§ Ø¨Ø§ Ù¾Ø¯ÛŒÙ†Ú¯ Ø®ÙˆØ¯ video-container */
  border-radius:12px;      /* Ù…Ø«Ù„ ÙˆÛŒØ¯ÛŒÙˆ */
  overflow:hidden;
  z-index:5;
  pointer-events:none;     /* Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ ÙˆÛŒØ¯ÛŒÙˆ Ø±Ùˆ Ù‚ÙÙ„ Ù†Ú©Ù†Ù‡ */
}

#curtain .half{
  position:absolute;
  top:0; bottom:0;
  width:50%;
  background:
    linear-gradient(to right, rgba(0,0,0,.85), rgba(70,0,0,.65), rgba(0,0,0,.85));
  box-shadow: inset 0 0 30px rgba(0,0,0,.6);
}

#curtain .left{left:0; border-right:1px solid rgba(255,255,255,.08);}
#curtain .right{right:0; border-left:1px solid rgba(255,255,255,.08);}

#curtain .shine{
  position:absolute;
  inset:0;
  background: radial-gradient(circle at 50% 50%, rgba(255,255,255,.10), rgba(0,0,0,0) 55%);
  opacity:.7;
}

#curtain.open .left{transform:translateX(-110%);}
#curtain.open .right{transform:translateX(110%);}
#curtain .left, #curtain .right{
  transition:transform 1.35s ease-in-out;
}

#curtain.hide{display:none;}
/* END CURTAIN */
/* ğŸ¬ REAL CINEMA CURTAIN */

.video-container{
  position:relative;
  overflow:hidden;
}

#curtain{
  position:absolute;
  inset:10px;
  border-radius:12px;
  z-index:10;
  pointer-events:none;
  display:flex;
}

#curtain .side{
  width:50%;
  height:100%;
  background:
    repeating-linear-gradient(
      90deg,
      #7a0000 0px,
      #b30000 20px,
      #7a0000 40px
    );
  box-shadow: inset 0 0 40px rgba(0,0,0,.6);
  transition:transform 1.6s cubic-bezier(.77,0,.18,1);
}

#curtain .left{
  transform:translateX(0);
}

#curtain .right{
  transform:translateX(0);
}

#curtain.open .left{
  transform:translateX(-105%);
}

#curtain.open .right{
  transform:translateX(105%);
}

#curtain.hide{
  display:none;
  }
</style>  
</head>  
  
<body>  
  
<div id="login">  
<div class="login-box glass">  
<h3>Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</h3>  
<input id="pass">  
<button onclick="checkPass()">ØªØ§ÛŒÛŒØ¯</button>  
</div>  
</div>  
  
<div id="welcomeOverlay">  
<div class="welcome-box glass">  
<h3>Ø³Ù„Ø§Ù… Ø¹Ø²ÛŒØ²Ù… â¤ï¸ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒ</h3>  
<button onclick="closeWelcome()">ÙˆØ±ÙˆØ¯</button>  
</div>  
</div>  
  
<header>  
<span>ğŸ¬ Watch Together</span>  
<div>  
<div style="display:flex;align-items:center;gap:8px;white-space:nowrap;">
  <span id="onlineWrapper" style="display:flex;align-items:center;gap:6px;">
  <span id="onlineDot"></span>
  <span id="online">Online: 1</span>
  </span>
<button onclick="toggleSettings()">âš™ï¸</button>  
</div>  
</header>  
  
<!-- ğŸ„ LIGHT STRING -->  
<div class="light-wrapper">  
<div class="light-wire">  
<svg viewBox="0 0 1000 100" preserveAspectRatio="none">  
<path d="M0,25 Q100,55 200,25 T400,25 T600,25 T800,25 T1000,25"  
stroke="#111" stroke-width="3" fill="transparent"/>  
</svg>  
</div>  
</div>  
  
<div id="settings" class="glass">  
<h3 style="margin-bottom:10px">Ù¾Ø®Ø´ ÙÛŒÙ„Ù…</h3>  
<input id="videoLinkInput" placeholder="Ù„ÛŒÙ†Ú© ÙÛŒÙ„Ù…..."  
style="width:100%;padding:8px;border-radius:10px;border:none;margin-bottom:8px">  
<button onclick="setVideoLink()">Ù¾Ø®Ø´ ÙÛŒÙ„Ù…</button>  
<hr style="margin:15px 0;opacity:.3">  
<button onclick="toggleDark()">Ø¯Ø§Ø±Ú© Ù…ÙˆØ¯</button>  
<button onclick="clearChat()">Ø­Ø°Ù ØªØ§Ø±ÛŒØ®Ú†Ù‡</button>  
<button onclick="toggleSettings()">Ø¨Ø³ØªÙ†</button>  
</div>  
  
<div class="main">  
<div class="video-container glass">  
<div class="video-container glass">

  <!-- ğŸ¬ REAL CURTAIN -->
  <div id="curtain">
    <div class="side left"></div>
    <div class="side right"></div>
  </div>

  <video id="video" controls></video>

</div>

  <video id="video" controls></video>  

</div>
  
<div class="chat-container glass">  
<div class="chat-box" id="chat"></div>  

<!-- âœ… Typing indicator -->
<div id="typingIndicator"></div>

<!-- âœ… Edit preview -->
<div id="editPreview">  
  <div class="ep-top">  
    <span>ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…</span>  
    <button id="cancelEdit" onclick="cancelEdit()">Ù„ØºÙˆ</button>  
  </div>  
  <div class="ep-text" id="editPreviewText"></div>  
</div>  

<!-- âœ… Reply preview (Telegram-like) -->
<div id="replyPreview">  
  <div class="rp-top">  
    <span>Reply</span>  
    <button id="cancelReply" onclick="cancelReply()">Ù„ØºÙˆ</button>  
  </div>  
  <div class="rp-text" id="replyPreviewText"></div>  
</div>  

<div class="input-area">  
<input id="msg" placeholder="Ù¾ÛŒØ§Ù…...">  
<button onclick="send()">Send</button>  
</div>  
</div>  
</div>  
  
<script>  
/* ğŸ„ CREATE SMALL BULBS */  
const colors=["#ff2d2d","#ffd400","#00ff88","#00aaff","#ff66ff"];  
const wrapper=document.querySelector(".light-wrapper");  
  
for(let i=0;i<30;i++){  
let bulb=document.createElement("div");  
bulb.className="bulb";  
bulb.style.left=(i*3.4)+"%";  
bulb.style.top=(14+Math.sin(i)*4)+"px";  
bulb.style.color=colors[Math.floor(Math.random()*colors.length)];  
bulb.style.animationDelay=(Math.random()*2)+"s";  
wrapper.appendChild(bulb);  
}  
  
setInterval(()=>{  
document.querySelectorAll(".bulb").forEach(b=>{  
b.style.color=colors[Math.floor(Math.random()*colors.length)];  
});  
},2000);  
</script>  
  
<script>  
alert("JS OK");
  var firebaseConfig={  
apiKey:"AIzaSyCDHmmKIYPHDyvx4BXTb-7VP6lmVb8BCYw",  
authDomain:"film-online-922c1.firebaseapp.com",  
databaseURL:"https://film-online-922c1-default-rtdb.firebaseio.com/",  
projectId:"film-online-922c1"  
};  
firebase.initializeApp(firebaseConfig);  
var db=firebase.database();  
  
var username="user"+Math.floor(Math.random()*1000);  
var myId=Math.random().toString(36).substr(2,9);  
var replyTo=null;  
var editKey=null;  
  
function checkPass(){
  var input = document.getElementById("pass").value.trim();

  if(input === "bazsho20"){
    document.getElementById("login").style.display = "none";
    document.getElementById("welcomeOverlay").style.display = "flex";
  } else {
    alert("Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡Ù‡");
  }
}
function closeWelcome(){welcomeOverlay.style.display="none"}  
function toggleSettings(){settings.classList.toggle("open")}  
function toggleDark(){document.body.classList.toggle("dark")}  
  
function setVideoLink(){  
var link=document.getElementById("videoLinkInput").value;  
if(!link)return;  
db.ref("video/url").set(link);  
videoLinkInput.value="";  
toggleSettings();  
}  
db.ref("video/url").on("value",snap=>{  
if(snap.val())video.src=snap.val();  
});  

/* ===================== */
/* âœ… VIDEO SYNC ADDED âœ… */
/* ===================== */
var vid=document.getElementById("video");  
var isSyncing=false;  
var lastSeekSend=0;  

function pushState(state){  
db.ref("video/state").set(state);  
}  
vid.addEventListener("play",()=>{  
  /* ğŸ­ CURTAIN OPEN (ADDED) */
  if(!window.__curtainOpened){
    window.__curtainOpened=true;
    var c=document.getElementById("curtain");
    if(c){
      c.classList.add("open");
      setTimeout(()=>{ c.classList.add("hide"); }, 1600);
    }
  }
  /* END CURTAIN */
vid.addEventListener("pause",()=>{

  var c=document.getElementById("curtain");
  if(c){
    c.classList.remove("hide");
    c.classList.remove("open");
  }

if(isSyncing)return;
pushState({
action:"pause",
time:vid.currentTime,
rate:vid.playbackRate,
ts:Date.now()
});
});
  if(isSyncing)return;  
  pushState({  
    action:"play",  
    time:vid.currentTime,  
    rate:vid.playbackRate,  
    ts:Date.now()  
  });  
});
vid.addEventListener("play",()=>{  
vid.addEventListener("play",()=>{

  var c=document.getElementById("curtain");
  if(c){
    c.classList.remove("hide");
    setTimeout(()=>{ c.classList.add("open"); },50);
    setTimeout(()=>{ c.classList.add("hide"); },1700);
  }

if(isSyncing)return;
pushState({
action:"play",
time:vid.currentTime,
rate:vid.playbackRate,
ts:Date.now()
});
});

vid.addEventListener("pause",()=>{  
if(isSyncing)return;  
pushState({  
action:"pause",  
time:vid.currentTime,  
rate:vid.playbackRate,  
ts:Date.now()  
});  
});  

vid.addEventListener("seeked",()=>{  
if(isSyncing)return;  
var now=Date.now();  
if(now-lastSeekSend<250)return;  
lastSeekSend=now;  
pushState({  
action:"seek",  
time:vid.currentTime,  
rate:vid.playbackRate,  
ts:now  
});  
});  

vid.addEventListener("ratechange",()=>{  
if(isSyncing)return;  
pushState({  
action:"rate",  
time:vid.currentTime,  
rate:vid.playbackRate,  
ts:Date.now()  
});  
});  

db.ref("video/state").on("value",snap=>{  
var s=snap.val();  
if(!s)return;  
isSyncing=true;  

if(typeof s.rate==="number" && vid.playbackRate!==s.rate){  
vid.playbackRate=s.rate;  
}  

if(typeof s.time==="number" && Math.abs(vid.currentTime-s.time)>0.6){  
try{vid.currentTime=s.time;}catch(e){}  
}  

if(s.action==="play"){  
var p=vid.play();  
if(p && p.catch)p.catch(()=>{});  
}  
if(s.action==="pause"){  
vid.pause();  
}  

setTimeout(()=>{isSyncing=false;},300);  
});  
/* ===== END SYNC ===== */  
  
/* ğŸŸ¢ PROFESSIONAL ONLINE SYSTEM */
var connectedRef = db.ref(".info/connected");

connectedRef.on("value", function(snap) {
  if (snap.val() === true) {
    var con = db.ref("online/" + myId);
    con.set({
      user: username,
      ts: Date.now()
    });
    con.onDisconnect().remove();
  }
});

db.ref("online").on("value", snap => {
  var count = 0;
  snap.forEach(child => {
    if(child.val()) count++;
  });
  document.getElementById("online").innerText = "Online: " + count;
});

/*****************************/
/* âœ… REPLY PREVIEW SYSTEM âœ… */
/*****************************/
function setReply(text){  
replyTo=text;  
var box=document.getElementById("replyPreview");  
var t=document.getElementById("replyPreviewText");  
t.innerText=text;  
box.style.display="block";  
try{msg.focus();}catch(e){}  
}  

function cancelReply(){  
replyTo=null;  
var box=document.getElementById("replyPreview");  
box.style.display="none";  
document.getElementById("replyPreviewText").innerText="";  
}  

/****************************/
/* âœ… EDIT MESSAGE SYSTEM âœ… */
/****************************/
function setEdit(key,oldText){  
editKey=key;  
document.getElementById("editPreviewText").innerText=oldText;  
document.getElementById("editPreview").style.display="block";  
msg.value=oldText;  
try{msg.focus();}catch(e){}  
cancelReply();  
}  

function cancelEdit(){  
editKey=null;  
document.getElementById("editPreview").style.display="none";  
document.getElementById("editPreviewText").innerText="";  
msg.value="";  
}  

/*****************************/
/* âœ… TYPING INDICATOR âœ…     */
/*****************************/
function setTyping(isTyping){  
db.ref("typing/"+myId).set(isTyping?{user:username,typing:true,ts:Date.now()}:null);  
}  
db.ref("typing/"+myId).onDisconnect().remove();  

var typingTimer=null;  
msg.addEventListener("input",()=>{  
setTyping(true);  
if(typingTimer)clearTimeout(typingTimer);  
typingTimer=setTimeout(()=>{  
setTyping(false);  
},900);  
});  
msg.addEventListener("blur",()=>{  
setTyping(false);  
});  

db.ref("typing").on("value",snap=>{  
var names=[];  
snap.forEach(c=>{  
if(c.key!==myId && c.val() && c.val().typing){  
names.push(c.val().user||"someone");  
}  
});  
var box=document.getElementById("typingIndicator");  
if(names.length){  
box.style.display="block";  
box.innerText=(names.length===1?names[0]:"Ú†Ù†Ø¯ Ù†ÙØ±")+" Ø¯Ø± Ø­Ø§Ù„ ØªØ§ÛŒÙ¾...";  
}else{  
box.style.display="none";  
box.innerText="";  
}  
});  

/*****************************/
/* âœ… CLOSE ANY OPEN PICKER âœ… */
/*****************************/
function closeAllPickers(){  
document.querySelectorAll(".reaction-picker").forEach(p=>p.remove());  
}  
document.addEventListener("click",()=>{  
closeAllPickers();  
});  

function send(){  
if(!msg.value)return;  

if(editKey){  
db.ref("chat/"+editKey+"/text").set(msg.value);  
db.ref("chat/"+editKey+"/edited").set(true);  
msg.value="";  
cancelEdit();  
setTyping(false);  
return;  
}  

db.ref("chat").push({  
text:msg.value,  
user:username,  
time:Date.now(),  
reply:replyTo,  
seen:false,  
edited:false,  
reactions:{}  
});  
msg.value="";  
cancelReply();  
setTyping(false);  
}  

/********************************************/
/* âœ… DOUBLE TAP / DOUBLE CLICK TO REPLY âœ… */
/********************************************/
var lastTapTimeByKey={};  

function attachReplyHandlers(div,key,text){  
div.addEventListener("dblclick",function(e){  
e.stopPropagation();  
setReply(text);  
});  

div.addEventListener("touchend",function(e){  
var now=Date.now();  
var last=lastTapTimeByKey[key]||0;  
lastTapTimeByKey[key]=now;  
if(now-last<320){  
try{e.preventDefault();}catch(err){}  
setReply(text);  
}  
},{passive:false});  
}  

db.ref("chat").on("child_added",snap=>{  
var d=snap.val();  
var key=snap.key;  
if(d.user!==username){  
db.ref("chat/"+key+"/seen").set(true);  
}  
var div=document.createElement("div");  
div.className="message "+(d.user===username?"me":"other");  
div.id="m_"+key;  
  
if(d.reply){  
var rep=document.createElement("div");  
rep.className="reply-box";  
rep.innerText=d.reply;  
div.appendChild(rep);  
}  
  
var text=document.createElement("div");  
text.innerText=d.text;  
div.appendChild(text);  
  
var meta=document.createElement("div");  
meta.className="meta";  

/*************************************/
/* âœ… SMALL BUTTONS PER MSG âœ… */
/*************************************/
var reactBtn=document.createElement("span");  
reactBtn.className="react-btn";  
reactBtn.innerText="ğŸ˜Š";  
reactBtn.onclick=function(ev){  
ev.stopPropagation();  
closeAllPickers();  
showReactions(key,div);  
};  

if(d.user===username){  
var editBtn=document.createElement("span");  
editBtn.className="edit-btn";  
editBtn.innerText="âœ";  
editBtn.onclick=function(ev){  
ev.stopPropagation();  
closeAllPickers();  
setEdit(key,d.text);  
};  
}  

meta.innerHTML=new Date(d.time).toLocaleTimeString().slice(0,5)  
+(d.edited?" <span style='opacity:.75'>(edited)</span>":"")  
+(d.user===username?" <span id='s"+key+"'>âœ”</span>":"");  

if(d.user===username){  
meta.appendChild(editBtn);  
}  
meta.appendChild(reactBtn);  
div.appendChild(meta);  
  
var react=document.createElement("div");  
react.className="reactions";  
div.appendChild(react);  

/********************************************/
/* âœ… CHANGE: click no longer sets reply âœ… */
/* (reply only on double tap / dblclick)    */
/********************************************/
div.onclick=function(e){  
e.stopPropagation();  
};  

attachReplyHandlers(div,key,d.text);  
  
chat.appendChild(div);  
chat.scrollTop=chat.scrollHeight;  
  
if(d.user===username){  
db.ref("chat/"+key+"/seen").on("value",s=>{  
document.getElementById("s"+key).innerText=s.val()?"âœ”âœ”":"âœ”";  
});  
}  
});  
  
function showReactions(key,div){  
if(div.querySelector(".reaction-picker"))return;  
var picker=document.createElement("div");  
picker.className="reaction-picker";  

/*************************************/
/* âœ… CANCEL/CLOSE BUTTON IN PANEL âœ… */
/*************************************/
var close=document.createElement("span");  
close.className="picker-close";  
close.innerText="âœ•";  
close.onclick=function(ev){  
ev.stopPropagation();  
picker.remove();  
};  
picker.appendChild(close);  

["ğŸ˜","ğŸ˜","ğŸ¤£","ğŸ©·","ğŸ‘Œ","ğŸ˜­","ğŸ˜¡","ğŸ”¥","ğŸ˜œ"].forEach(e=>{  
var span=document.createElement("span");  
span.innerText=e;  
span.onclick=function(ev){  
ev.stopPropagation();  
db.ref("chat/"+key+"/reactions/"+myId).set(e);  
picker.remove();  
};  
picker.appendChild(span);  
});  
div.appendChild(picker);  
}  
  
db.ref("chat").on("child_changed",snap=>{  
var d=snap.val();  

/********** update message text + edited label **********/
var m=document.getElementById("m_"+snap.key);  
if(m){  
var mainText=m.querySelector("div:nth-child("+(d.reply?2:1)+")");  
if(mainText)mainText.innerText=d.text;  

var meta=m.querySelector(".meta");  
if(meta){  
var timeStr=new Date(d.time).toLocaleTimeString().slice(0,5);  
var editedStr=d.edited?" <span style='opacity:.75'>(edited)</span>":"";  
if(d.user===username){  
meta.innerHTML=timeStr+editedStr+" <span id='s"+snap.key+"'>"+(d.seen?"âœ”âœ”":"âœ”")+"</span>";  
var editBtn=document.createElement("span");  
editBtn.className="edit-btn";  
editBtn.innerText="âœ";  
editBtn.onclick=function(ev){  
ev.stopPropagation();  
closeAllPickers();  
setEdit(snap.key,d.text);  
};  
meta.appendChild(editBtn);  

var reactBtn=document.createElement("span");  
reactBtn.className="react-btn";  
reactBtn.innerText="ğŸ˜Š";  
reactBtn.onclick=function(ev){  
ev.stopPropagation();  
closeAllPickers();  
showReactions(snap.key,m);  
};  
meta.appendChild(reactBtn);  
}else{  
meta.innerHTML=timeStr+editedStr;  
var reactBtn=document.createElement("span");  
reactBtn.className="react-btn";  
reactBtn.innerText="ğŸ˜Š";  
reactBtn.onclick=function(ev){  
ev.stopPropagation();  
closeAllPickers();  
showReactions(snap.key,m);  
};  
meta.appendChild(reactBtn);  
}  
}  
}  

/********** update reactions **********/
var react=document.querySelector("#m_"+snap.key+" .reactions");  
if(react){  
react.innerHTML="";  
if(d.reactions){  
Object.values(d.reactions).forEach(e=>{  
react.innerHTML+=e+" ";  
});  
}  
}  
});  
  
function clearChat(){  
db.ref("chat").remove();  
chat.innerHTML="";  
cancelReply();  
cancelEdit();  
}  
</script>  
  
</body>  
</html>
